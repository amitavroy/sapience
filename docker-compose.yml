networks:
  sapience:

services:
  php-base-dev: &php-base-dev
    profiles: ["development"]
    build:
      context: .
      dockerfile: ./docker/php/php.dockerfile
      target: development
      args:
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
    volumes:
      - .:/var/www/html
    networks:
      - sapience
    extra_hosts:
      - "host.docker.internal:host-gateway"

  php-dev:
    profiles: ["development"]
    <<: *php-base-dev
    ports:
      - ${APP_PORT:-80}:8080
    depends_on:
      - mysql
      - phpmyadmin
      - redis

  worker-dev:
    <<: *php-base-dev
    profiles: ["development"]
    depends_on:
      - mysql
      - redis
    command: php artisan queue:listen --timeout=3600
    restart: unless-stopped

  php-base-prod: &php-base-prod
    profiles: ["production"]
    build:
      context: .
      dockerfile: ./docker/php/php.dockerfile
      target: production
      args:
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
    networks:
      - sapience
    extra_hosts:
      - "host.docker.internal:host-gateway"

  php-prod:
    profiles: ["production"]
    <<: *php-base-prod
    ports:
      - ${APP_PORT:-80}:8080
    depends_on:
      - mysql
      - redis

  worker-prod:
    <<: *php-base-prod
    profiles: ["production"]
    depends_on:
      - mysql
      - redis
    command: php artisan queue:listen --timeout=3600
    restart: unless-stopped

  mysql:
    image: mariadb:lts
    restart: unless-stopped
    profiles: ["development", "production"]
    tty: true
    ports:
      - ${DB_EXTERNAL_PORT:-3307}:3306
    volumes:
      - ./docker/data/mysql:/var/lib/mysql
    networks:
      - sapience
    environment:
      MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: 1
      MARIADB_DATABASE: ${DB_DATABASE:-sapience}
      MARIADB_USER: ${DB_USERNAME:-sapience}
      MARIADB_PASSWORD: ${DB_PASSWORD:-sapience}
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  searxng:
    image: docker.io/searxng/searxng:latest
    restart: unless-stopped
    profiles: ["development", "production"]
    ports:
      - ${SEARXNG_PORT:-8888}:8080
    volumes:
      - ./docker/data/searxng:/etc/searxng
      - ./docker/data/searxng:/var/cache/searxng
    networks:
      - sapience

  phpmyadmin:
    depends_on:
      - mysql
    image: phpmyadmin
    profiles: ["development"]
    restart: unless-stopped
    ports:
      - ${DB_ADMIN_UI:-8080}:80
    networks:
      - sapience
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-}
      MYSQL_USER: ${DB_USERNAME:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD:-}
      PMA_HOST: mysql

  redis:
    image: redis:latest
    restart: unless-stopped
    profiles: ["development", "production"]
    tty: true
    ports:
      - ${REDIS_PORT:-6379}:6379
    networks:
      - sapience

  mailpit:
    image: axllent/mailpit:v1.16
    profiles: ["development"]
    restart: unless-stopped
    ports:
      - ${MAILPIT_WEBUI:-8025}:8025
      - ${MAILPIT_SMTP:-1025}:1025
    volumes:
      - ./docker/data/mailpit:/data
    networks:
      - sapience
    environment:
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ALLOW_INSECURE: true
      MP_MAX_MESSAGES: ${MAILPIT_MESSAGES:-100}

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    profiles: ["development", "production"]
    ports:
      - ${MINIO_API_PORT:-9000}:9000
      - ${MINIO_CONSOLE_PORT:-9001}:9001
    volumes:
      - ./docker/data/minio:/data
    networks:
      - sapience
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_API_CORS_ALLOW_ORIGIN: ${MINIO_API_CORS_ALLOW_ORIGIN:-http://localhost:8000,http://127.0.0.1:8000}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  typesense:
    image: typesense/typesense:29.0
    profiles: ["development", "production"]
    restart: unless-stopped
    ports:
      - 8110:8108
    volumes:
      - ./docker/data/typesense:/data
    command: '--data-dir /data --api-key=${TYPESENSE_API_KEY:-xyz} --enable-cors'
    networks:
      - sapience

  typesense-dashboard:
    image: ghcr.io/bfritscher/typesense-dashboard:latest
    restart: unless-stopped
    profiles: ["development"]
    ports:
      - ${TYPESENSE_DASHBOARD_PORT:-8109}:80
    networks:
      - sapience
    environment:
      TYPESENSE_SERVER: http://typesense:8108
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY:-xyz}
    depends_on:
      - typesense
